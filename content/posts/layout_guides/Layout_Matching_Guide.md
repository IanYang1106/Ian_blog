# IC Layout Matching

## 1. 什麼是 IC Layout Matching

在積體電路 (Integrated Circuit, IC) 設計中，同一個電路模組內，有些元件（如電阻、電容、BJT 或 MOSFET 等）常需要高度一致的電氣特性，以確保電路功能的正確與穩定。

舉例來說，差動放大器 (Differential Amplifier) 中的差動對 (differential pair) 通常要有相同的晶體管尺寸與相似的製程環境，才能達到良好的對稱性與較低的失調 (offset)。

**IC Layout Matching** 的目的，就是在佈局設計上盡可能確保這些關鍵元件的製程條件、尺寸、寄生參數等都盡量相同，來降低器件之間的誤差。

## 2. 常見需要 Matching 的電路

### 2.1 類比前端電路
1. **差動放大器 (Differential Amplifier)**
   - 差動對 (Differential Pair) 的 MOSFET
   - 電流鏡負載 (Current Mirror Load)
   - 尾端電流源 (Tail Current Source)

2. **運算放大器 (Op-Amp)**
   - 輸入級差動對
   - 偏壓電流鏡
   - 輸出級推挽電路 (Push-Pull)

3. **比較器 (Comparator)**
   - 輸入差動對
   - 鎖存級 (Latch Stage) 的交叉耦合對
   - 偏壓電路

### 2.2 類比基本元件
1. **電流鏡 (Current Mirror)**
   - 基本電流鏡對
   - 串聯電流鏡
   - 寬擺幅電流鏡
   - 高精度電流鏡

2. **參考電路 (Reference)**
   - 電流參考中的電阻對
   - 電壓參考中的電晶體對
   - 溫度補償電路

3. **偏壓電路 (Bias)**
   - 自偏壓電路中的電流通道
   - 溫度補償偏壓
   - 啟動電路

### 2.3 資料轉換器
1. **類比數位轉換器 (ADC)**
   - Flash ADC 的比較器陣列
   - 電流切換 DAC 的電流源陣列
   - SAR ADC 的電容陣列

2. **數位類比轉換器 (DAC)**
   - 電流源陣列
   - R-2R 梯形網路
   - 電容陣列切換網路

### 2.4 濾波器電路
1. **連續時間濾波器**
   - Gm-C 濾波器中的跨導放大器
   - 主動 RC 濾波器中的運放
   - 電阻與電容陣列

2. **切換電容濾波器**
   - 切換電容
   - 運算放大器
   - 時脈驅動電路

### 2.5 特殊應用電路
1. **感測器前端**
   - 橋式電路的電阻匹配
   - 電荷放大器
   - 儀表放大器

2. **射頻電路**
   - 混頻器的差動對
   - LNA 的匹配網路
   - VCO 的交叉耦合對

3. **記憶體**
   - SRAM 的交叉耦合對
   - 感測放大器
   - 位元線負載

### 2.6 匹配要求等級
1. **高精度要求 (≤0.1%)**
   - 高精度 ADC/DAC
   - 高精度參考源
   - 精密儀表放大器

2. **中等精度要求 (0.1%~1%)**
   - 一般運算放大器
   - 類比濾波器
   - 一般電流鏡

3. **一般精度要求 (>1%)**
   - 數位電路中的差動信號
   - 一般偏壓電路
   - 輸出級電路

## 3. 為什麼需要 Layout Matching

### 1. 降低失調與偏差 (Offset)
- 在類比電路中，若差動對的兩個 MOSFET 特性不匹配，將導致輸出有不必要的失調電壓或電流
- 影響電路的準確度及穩定度

### 2. 提升電路穩定度
- 製程及環境上的細微差異，常使得相同設計尺寸的元件實際卻有不同特性
- 透過 Matching，可使重要元件在相同的製程與佈局條件下工作
- 減少溫度效應、壓力效應與寄生電阻差異帶來的不一致

### 3. 提升電路線性度
- 在精密應用中（如精密放大器、DAC/ADC、濾波器等），線性度非常重要
- 良好的元件匹配有助於保持系統的整體線性度，提高精度

## 4. Matching 的重要觀念

### 1. 共用相同的製程層 (Process Layer)
- 即使元件的幾何尺寸設計一樣，但若製程結構不同，最終仍會造成電特性的差異
- **建議：** 同一組需匹配的元件應儘量使用相同的層次 (layer) 與結構

### 2. 相同的佈局方向 (Orientation)
- 元件的方向改變可能會受到製程應力或不對稱效應影響
- **建議：** 儘量讓同組匹配元件維持相同的方向或利用特定對稱布局方式

### 3. 對稱性 (Symmetry)
- 透過對稱性來確保寄生電阻、電容等場效應盡可能相同
- **建議：** 差動電路中，將差動對的兩個元件在左右或上下位置保持對稱

### 4. 避免熱梯度 (Thermal Gradient)
- 熱梯度會引起元件在矽晶圓上不同位置產生不同特性
- **建議：** 盡量將匹配元件放在熱分佈均勻的區域，或盡可能靠近放置

### 5. Dummy 元件 (Dummy Devices)
- 在匹配結構邊緣添加「dummy」元件，用以補償或減少邊緣效應
- **建議：** 常見在 MOSFET 排列邊緣放置 dummy，使中間的 MOSFET 有更均勻的環境

## 5. 常見的 Layout Matching 技巧

### 1. 共心 (Common-Centroid) 佈局
- 將一組要匹配的元件以中心為對稱點，交錯排列（例如 ABBA 形式）
- 好處：可以抵消製程中的梯度效應
- 常用於差動對的匹配，或是電容的精密匹配

### 2. 交叉 (Interdigitated) 排列
- 將多個相同元件交錯在一起，如 A-B-A-B 的形式
- 好處：可均勻分散在版圖的空間，降低區域性製程變異影響
- 適用：例如多個電晶體需要相同汲極/源極佈局，或多個相同電阻分段後交錯排列

### 3. 鏡像 (Mirroring) 或旋轉
- 有時會採用 180° 鏡像佈局，使得兩個元件在某些方向的應力或梯度互相抵消
- 需注意：若製程對旋轉後的元件有更大誤差，就得小心使用

### 4. 護環 (Guard Ring)
- 為了避免雜散汙染或噪聲耦合，會在匹配結構外圍加一圈 Guard Ring
- 可有效減少元件間的相互干擾，也提升匹配度與穩定度

### 5. Dummy 元件
- 在元件排布的邊緣添加 dummy，以確保邊緣處的製程特性與中間處一致
- 在類比電阻、MOSFET 排列等皆常見

## 5.1 Matching 排列範例

### 1. 一維排列 (1D Arrangement)

#### 1.1 兩元件匹配 (AB)
```
基本型：
A | B                    // 簡單配置，匹配性較差

ABBA型：
A | B | B | A           // 中心對稱，常用於差動對

交錯型：
A | B | A | B           // 均勻分布，適用於電流鏡
```

#### 1.2 三元件匹配 (ABC)
```
基本型：
A | B | C               // 簡單三元件配置

對稱型：
A | B | C | C | B | A   // 完全對稱配置

交錯型：
A | B | C | A | B | C   // 週期性重複
```

#### 1.3 四元件匹配 (ABCD)
```
基本型：
A | B | C | D           // 基本四元件配置

對稱型：
A | B | C | D | D | C | B | A   // 完全對稱配置

交錯型：
A | B | C | D | A | B | C | D   // 週期性重複
```

### 2. 二維排列 (2D Arrangement)

#### 2.1 兩元件匹配 (AB)
```
2x2 共心型：
A B
B A

2x4 交錯型：
A B A B
B A B A
```

#### 2.2 三元件匹配 (ABC)
```
3x3 環形型：
A B C
C A B
B C A

3x3 對稱型：
A B C
B C A
C A B
```

#### 2.3 四元件匹配 (ABCD)
```
2x4 對稱型：
A B C D
D C B A

4x4 共心型：
A B C D
D A B C
C D A B
B C D A
```

### 3. 特殊匹配模式

#### 3.1 不同比例匹配
```
1:2 比例：
A | B1 | B2 | B2 | B1 | A    // A:B = 1:2

1:3 比例：
A | B1 | B2 | B3 | B3 | B2 | B1 | A    // A:B = 1:3
```

#### 3.2 多重交錯匹配
```
二層交錯：
[A B] [B A] | [A B] [B A]    // 方括號表示一組
[B A] [A B] | [B A] [A B]    // 小組內部匹配，大組間也匹配

三層交錯：
{[A B] [B A]} {[B A] [A B]}  // 大括號表示最外層分組
{[B A] [A B]} {[A B] [B A]}  // 三層結構都保持對稱
```

#### 3.3 混合型匹配
```
AB-ABC混合：
(A B) (B A) | (A B C) (C B A)    // 小括號表示不同類型分組

ABC-ABCD混合：
(A B C) | (A B C D) | (D C B A) | (C B A)
```

### 4. 匹配模式選擇建議

1. **精度要求**
   - 高精度：使用二維共心配置
   - 中等精度：使用一維對稱配置
   - 一般精度：使用簡單交錯配置

2. **面積限制**
   - 嚴格限制：優先考慮一維配置
   - 適中限制：可使用簡單二維配置
   - 寬鬆限制：可使用完整二維共心配置

3. **元件數量**
   - 2個元件：ABBA 或 2x2共心
   - 3個元件：ABCCBA 或 3x3環形
   - 4個元件：ABCDDCBA 或 4x4共心

4. **特殊考量**
   - 溫度梯度：優先使用緊湊型二維配置
   - 應力效應：考慮使用交錯型配置
   - 製程梯度：採用對稱型配置

## 6. 一般設計步驟

### 1. 確定要匹配的關鍵元件
- 在電路設計階段就需確定哪些元件必須高度匹配
- 如差動對、電阻比例網路、電流鏡等

### 2. 選擇佈局策略
- 根據電路需求與製程條件，選擇合適的匹配技術
- 如 common-centroid 或 interdigitated 等

### 3. 考慮寄生效應與線寬
- 金屬走線與接觸孔也會造成寄生效應
- 採用對稱或等長線以確保匹配

### 4. 加入 Dummy 元件與 Guard Ring
- 在元件邊緣加上 dummy 補償
- 考慮是否需要 Guard Ring 隔離

### 5. 檢查與驗證
- 使用 DRC、LVS 與 PEX 檢查匹配結構
- 必要時進行後模擬驗證

## 7. 可能的問題與注意事項

### 1. 忽略製程梯度
- 大面積晶片上可能存在摻雜梯度、厚度變化等
- 忽略此因素會降低匹配精度

### 2. 對稱性不足
- 佈局若無良好的鏡像或交錯排布
- 容易讓寄生效應或外界干擾不均

### 3. 熱效應
- 功率較高區域靠近敏感元件
- 可能導致溫度分布不均

### 4. 連線不對稱
- 金屬線電阻或電容不一致
- 可能抵銷匹配的好處

### 5. 忽略比例需求
- 需要考慮元件的實際比例關係
- 確保面積或單元數量符合設計需求

## 8. 結論

IC Layout Matching 是類比設計中的關鍵技術：
- 透過對稱性、交錯設計等手法降低製程誤差
- 初學者應掌握「同層、同向、對稱、等長」等原則
- 設計時充分考慮匹配技巧，可減少返工機會
- 良好的匹配設計有助於提升電路的功能、精度與穩定度